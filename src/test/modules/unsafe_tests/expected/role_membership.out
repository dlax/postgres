--
-- Tests for database-specific role memberships.
--
-- Clean up in case a prior regression run failed
-- Suppress NOTICE messages when users/groups don't exist
SET client_min_messages TO 'warning';
DROP ROLE IF EXISTS regress_priv_group1;
DROP ROLE IF EXISTS regress_priv_group2;
DROP DATABASE IF EXISTS db_4;
DROP DATABASE IF EXISTS db_3;
DROP DATABASE IF EXISTS db_2;
DROP DATABASE IF EXISTS db_1;
DROP ROLE IF EXISTS role_granted;
DROP ROLE IF EXISTS role_read_34;
DROP ROLE IF EXISTS role_inherited_3;
DROP ROLE IF EXISTS role_inherited_34;
DROP ROLE IF EXISTS role_read_0;
DROP ROLE IF EXISTS role_read_12;
DROP ROLE IF EXISTS role_read_12_noinherit;
DROP ROLE IF EXISTS role_read_all_noinherit;
DROP ROLE IF EXISTS role_read_all_with_admin;
DROP DATABASE IF EXISTS db_0;
DROP ROLE IF EXISTS role_admin;
RESET client_min_messages;
-- test proper begins here
CREATE ROLE role_admin LOGIN CREATEROLE CREATEDB;
GRANT pg_read_all_data TO role_admin WITH ADMIN OPTION;
GRANT pg_read_all_stats TO role_admin WITH ADMIN OPTION;
GRANT pg_maintain TO role_admin WITH ADMIN OPTION;
-- Populate test databases.
CREATE DATABASE db_0 OWNER role_admin;
\connect db_0
CREATE TABLE data AS SELECT generate_series(1, 3);
CREATE VIEW role_memberships
 AS
SELECT
  r.rolname as role,
  m.rolname as member,
  CASE WHEN g.rolsuper THEN 'superuser' ELSE g.rolname END as grantor,
  admin_option,
  d.datname
FROM pg_auth_members a
JOIN pg_roles r ON r.oid = a.roleid
JOIN pg_roles m ON m.oid = a.member
LEFT JOIN pg_roles g ON g.oid = a.grantor
LEFT JOIN pg_database d ON d.oid = a.dbid
WHERE
  m.rolname LIKE 'role_%'
ORDER BY
  1, 2, 5, 3
;
CREATE DATABASE db_1 TEMPLATE db_0 OWNER role_admin;
CREATE DATABASE db_2 TEMPLATE db_1 OWNER role_admin;
CREATE DATABASE db_3 TEMPLATE db_1 OWNER role_admin;
CREATE DATABASE db_4 TEMPLATE db_1 OWNER role_admin;
SET SESSION AUTHORIZATION role_admin;
-- Read all cluster-wide with admin option
CREATE ROLE role_read_all_with_admin ROLE role_admin;
GRANT pg_read_all_data TO role_read_all_with_admin WITH ADMIN OPTION;
-- Read all in databases 1 and 2
CREATE ROLE role_read_12 ROLE role_admin;
GRANT pg_read_all_data TO role_read_12 IN DATABASE db_1;
GRANT pg_read_all_data TO role_read_12 IN DATABASE db_2;
-- Read all in databases 3 and 4 with admin option
CREATE ROLE role_read_34 ROLE role_admin;
GRANT pg_read_all_data TO role_read_34 IN DATABASE db_3 WITH ADMIN OPTION;
GRANT pg_read_all_data TO role_read_34 IN DATABASE db_4 WITH ADMIN OPTION;
-- Inherits read all in databases 3 and 4
CREATE ROLE role_inherited_34 ROLE role_admin;
GRANT role_read_34 TO role_inherited_34;
-- Inherits read all in database 3
CREATE ROLE role_inherited_3 ROLE role_admin;
GRANT role_read_34 TO role_inherited_3 IN DATABASE db_3;
-- No inherit
CREATE ROLE role_read_all_noinherit NOINHERIT ROLE role_admin;
GRANT role_read_all_with_admin TO role_read_all_noinherit;
-- No inherit in databases 1 and 2
CREATE ROLE role_read_12_noinherit NOINHERIT ROLE role_admin;
GRANT role_read_12 TO role_read_12_noinherit;
-- Alternate syntax
CREATE ROLE role_read_0;
GRANT pg_read_all_data TO role_read_0, role_read_all_noinherit IN CURRENT DATABASE;
-- Failure due to missing database
GRANT pg_read_all_data TO role_read_0 IN DATABASE non_existent; -- error
ERROR:  database "non_existent" does not exist
-- Should warn on duplicate grants
GRANT pg_read_all_data TO role_read_all_with_admin; -- notice
NOTICE:  role "role_read_all_with_admin" has already been granted membership in role "pg_read_all_data" by role "role_admin"
GRANT pg_read_all_data TO role_read_0 IN DATABASE db_0; -- notice
NOTICE:  role "role_read_0" has already been granted membership in role "pg_read_all_data" in database "db_0" by role "role_admin"
-- Should not warn if adjusting admin option
GRANT pg_read_all_data TO role_read_0 IN DATABASE db_0 WITH ADMIN OPTION; -- silent
GRANT pg_read_all_data TO role_read_0 IN DATABASE db_0 WITH ADMIN OPTION; -- notice
NOTICE:  role "role_read_0" has already been granted membership in role "pg_read_all_data" in database "db_0" by role "role_admin"
GRANT pg_maintain TO role_read_12 IN DATABASE db_2;
-- Cluster-wide role
GRANT pg_read_all_stats TO role_read_0;
GRANT pg_read_all_stats TO role_read_34 IN DATABASE db_3;  -- makes no sense XXX
-- Check membership table
TABLE role_memberships;
           role           |          member          |  grantor   | admin_option | datname 
--------------------------+--------------------------+------------+--------------+---------
 pg_maintain              | role_admin               | superuser  | t            | 
 pg_maintain              | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_admin               | superuser  | t            | 
 pg_read_all_data         | role_read_0              | role_admin | t            | db_0
 pg_read_all_data         | role_read_12             | role_admin | f            | db_1
 pg_read_all_data         | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_read_34             | role_admin | t            | db_3
 pg_read_all_data         | role_read_34             | role_admin | t            | db_4
 pg_read_all_data         | role_read_all_noinherit  | role_admin | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin | t            | 
 pg_read_all_stats        | role_admin               | superuser  | t            | 
 pg_read_all_stats        | role_read_0              | role_admin | f            | 
 pg_read_all_stats        | role_read_34             | role_admin | f            | db_3
 role_inherited_3         | role_admin               | role_admin | f            | 
 role_inherited_3         | role_admin               | superuser  | t            | 
 role_inherited_34        | role_admin               | role_admin | f            | 
 role_inherited_34        | role_admin               | superuser  | t            | 
 role_read_0              | role_admin               | superuser  | t            | 
 role_read_12             | role_admin               | role_admin | f            | 
 role_read_12             | role_admin               | superuser  | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | superuser  | t            | 
 role_read_34             | role_admin               | role_admin | f            | 
 role_read_34             | role_admin               | superuser  | t            | 
 role_read_34             | role_inherited_3         | role_admin | f            | db_3
 role_read_34             | role_inherited_34        | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_admin               | role_admin | f            | 
 role_read_all_with_admin | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin | f            | 
(32 rows)

-- Test membership privileges (db_1)
\connect db_1
SET SESSION AUTHORIZATION role_admin;
SET ROLE role_read_all_with_admin;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_12;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_34;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_inherited_34;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_inherited_3;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET SESSION AUTHORIZATION role_read_12;
VACUUM data; -- error
WARNING:  permission denied to vacuum "data", skipping it
SET ROLE pg_read_all_data; -- success
SET SESSION AUTHORIZATION role_inherited_34;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET ROLE role_read_34; -- success
SET SESSION AUTHORIZATION role_inherited_3;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET ROLE role_read_34; -- error
ERROR:  permission denied to set role "role_read_34"
SET SESSION AUTHORIZATION role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE pg_read_all_data; -- success
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET SESSION AUTHORIZATION role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12; -- success
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

-- Test membership privileges (db_2)
\connect db_2
SET SESSION AUTHORIZATION role_admin;
SET ROLE role_read_all_with_admin;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_12;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_34;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_inherited_34;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_inherited_3;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET SESSION AUTHORIZATION role_read_12;
VACUUM data; -- success
SET ROLE pg_read_all_data; -- success
SET SESSION AUTHORIZATION role_inherited_34;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET ROLE role_read_34; -- success
SET SESSION AUTHORIZATION role_inherited_3;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET ROLE role_read_34; -- error
ERROR:  permission denied to set role "role_read_34"
SET SESSION AUTHORIZATION role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE pg_read_all_data; -- success
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET SESSION AUTHORIZATION role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12; -- success
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

-- Test membership privileges (db_3)
\connect db_3
SET SESSION AUTHORIZATION role_admin;
SET ROLE role_read_all_with_admin;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_12;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_34;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_inherited_34;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_inherited_3;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET SESSION AUTHORIZATION role_read_12;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET SESSION AUTHORIZATION role_inherited_34;
SET ROLE pg_read_all_data; -- success
SET ROLE role_read_34; -- success
SET SESSION AUTHORIZATION role_inherited_3;
SET ROLE pg_read_all_data; -- success
SET ROLE role_read_34; -- success
SET SESSION AUTHORIZATION role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE pg_read_all_data; -- success
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET SESSION AUTHORIZATION role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12; -- error
SELECT * FROM data; -- error
ERROR:  permission denied for table data
-- Test membership privileges (db_4)
\connect db_4
SET SESSION AUTHORIZATION role_admin;
SET ROLE role_read_all_with_admin;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_read_12;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_34;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_inherited_34;
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET ROLE role_inherited_3;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET SESSION AUTHORIZATION role_read_12;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET SESSION AUTHORIZATION role_inherited_34;
SET ROLE pg_read_all_data; -- success
SET ROLE role_read_34; -- success
SET SESSION AUTHORIZATION role_inherited_3;
SET ROLE pg_read_all_data; -- error
ERROR:  permission denied to set role "pg_read_all_data"
SET ROLE role_read_34; -- error
ERROR:  permission denied to set role "role_read_34"
SET SESSION AUTHORIZATION role_read_all_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE pg_read_all_data; -- success
SELECT * FROM data; -- success
 generate_series 
-----------------
               1
               2
               3
(3 rows)

SET SESSION AUTHORIZATION role_read_12_noinherit;
SELECT * FROM data; -- error
ERROR:  permission denied for table data
SET ROLE role_read_12; -- error
SELECT * FROM data; -- error
ERROR:  permission denied for table data
\connect db_0
-- Test cluster-wide role
SET SESSION AUTHORIZATION role_read_0;
SELECT application_name, query FROM pg_stat_activity WHERE datname = 'db_0';
      application_name      |                                    query                                     
----------------------------+------------------------------------------------------------------------------
 pg_regress/role_membership | SELECT application_name, query FROM pg_stat_activity WHERE datname = 'db_0';
(1 row)

SET SESSION AUTHORIZATION role_read_12;
SELECT application_name, query FROM pg_stat_activity;
      application_name      |          query           
----------------------------+--------------------------
 pg_regress/role_membership | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
(6 rows)

\connect db_3
SET SESSION AUTHORIZATION role_read_34;
SELECT application_name, query FROM pg_stat_activity;
      application_name      |          query           
----------------------------+--------------------------
 pg_regress/role_membership | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
                            | <insufficient privilege>
(6 rows)

\connect db_0
SET SESSION AUTHORIZATION role_admin;
-- Should not warn if revoking admin option
REVOKE ADMIN OPTION FOR pg_read_all_data FROM role_read_0 IN DATABASE db_0; -- silent
REVOKE ADMIN OPTION FOR pg_read_all_data FROM role_read_0 IN DATABASE db_0; -- silent
TABLE role_memberships;
           role           |          member          |  grantor   | admin_option | datname 
--------------------------+--------------------------+------------+--------------+---------
 pg_maintain              | role_admin               | superuser  | t            | 
 pg_maintain              | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_admin               | superuser  | t            | 
 pg_read_all_data         | role_read_0              | role_admin | f            | db_0
 pg_read_all_data         | role_read_12             | role_admin | f            | db_1
 pg_read_all_data         | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_read_34             | role_admin | t            | db_3
 pg_read_all_data         | role_read_34             | role_admin | t            | db_4
 pg_read_all_data         | role_read_all_noinherit  | role_admin | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin | t            | 
 pg_read_all_stats        | role_admin               | superuser  | t            | 
 pg_read_all_stats        | role_read_0              | role_admin | f            | 
 pg_read_all_stats        | role_read_34             | role_admin | f            | db_3
 role_inherited_3         | role_admin               | role_admin | f            | 
 role_inherited_3         | role_admin               | superuser  | t            | 
 role_inherited_34        | role_admin               | role_admin | f            | 
 role_inherited_34        | role_admin               | superuser  | t            | 
 role_read_0              | role_admin               | superuser  | t            | 
 role_read_12             | role_admin               | role_admin | f            | 
 role_read_12             | role_admin               | superuser  | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | superuser  | t            | 
 role_read_34             | role_admin               | role_admin | f            | 
 role_read_34             | role_admin               | superuser  | t            | 
 role_read_34             | role_inherited_3         | role_admin | f            | db_3
 role_read_34             | role_inherited_34        | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_admin               | role_admin | f            | 
 role_read_all_with_admin | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin | f            | 
(32 rows)

-- Should warn if revoking a non-existent membership
REVOKE pg_read_all_data FROM role_read_0 IN DATABASE db_0; -- success
REVOKE pg_read_all_data FROM role_read_0 IN DATABASE db_0; -- warning
WARNING:  role "role_read_0" has not been granted membership in role "pg_read_all_data" by role "role_admin"
TABLE role_memberships;
           role           |          member          |  grantor   | admin_option | datname 
--------------------------+--------------------------+------------+--------------+---------
 pg_maintain              | role_admin               | superuser  | t            | 
 pg_maintain              | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_admin               | superuser  | t            | 
 pg_read_all_data         | role_read_12             | role_admin | f            | db_1
 pg_read_all_data         | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_read_34             | role_admin | t            | db_3
 pg_read_all_data         | role_read_34             | role_admin | t            | db_4
 pg_read_all_data         | role_read_all_noinherit  | role_admin | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin | t            | 
 pg_read_all_stats        | role_admin               | superuser  | t            | 
 pg_read_all_stats        | role_read_0              | role_admin | f            | 
 pg_read_all_stats        | role_read_34             | role_admin | f            | db_3
 role_inherited_3         | role_admin               | role_admin | f            | 
 role_inherited_3         | role_admin               | superuser  | t            | 
 role_inherited_34        | role_admin               | role_admin | f            | 
 role_inherited_34        | role_admin               | superuser  | t            | 
 role_read_0              | role_admin               | superuser  | t            | 
 role_read_12             | role_admin               | role_admin | f            | 
 role_read_12             | role_admin               | superuser  | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | superuser  | t            | 
 role_read_34             | role_admin               | role_admin | f            | 
 role_read_34             | role_admin               | superuser  | t            | 
 role_read_34             | role_inherited_3         | role_admin | f            | db_3
 role_read_34             | role_inherited_34        | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_admin               | role_admin | f            | 
 role_read_all_with_admin | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin | f            | 
(31 rows)

-- Revoke should only apply to the specified level
REVOKE pg_read_all_data FROM role_read_12; -- warning
TABLE role_memberships;
           role           |          member          |  grantor   | admin_option | datname 
--------------------------+--------------------------+------------+--------------+---------
 pg_maintain              | role_admin               | superuser  | t            | 
 pg_maintain              | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_admin               | superuser  | t            | 
 pg_read_all_data         | role_read_12             | role_admin | f            | db_2
 pg_read_all_data         | role_read_34             | role_admin | t            | db_3
 pg_read_all_data         | role_read_34             | role_admin | t            | db_4
 pg_read_all_data         | role_read_all_noinherit  | role_admin | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin | t            | 
 pg_read_all_stats        | role_admin               | superuser  | t            | 
 pg_read_all_stats        | role_read_0              | role_admin | f            | 
 pg_read_all_stats        | role_read_34             | role_admin | f            | db_3
 role_inherited_3         | role_admin               | role_admin | f            | 
 role_inherited_3         | role_admin               | superuser  | t            | 
 role_inherited_34        | role_admin               | role_admin | f            | 
 role_inherited_34        | role_admin               | superuser  | t            | 
 role_read_0              | role_admin               | superuser  | t            | 
 role_read_12             | role_admin               | role_admin | f            | 
 role_read_12             | role_admin               | superuser  | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | role_admin | f            | 
 role_read_12_noinherit   | role_admin               | superuser  | t            | 
 role_read_34             | role_admin               | role_admin | f            | 
 role_read_34             | role_admin               | superuser  | t            | 
 role_read_34             | role_inherited_3         | role_admin | f            | db_3
 role_read_34             | role_inherited_34        | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | role_admin | f            | 
 role_read_all_noinherit  | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_admin               | role_admin | f            | 
 role_read_all_with_admin | role_admin               | superuser  | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin | f            | 
(30 rows)

-- Ensure cluster-wide admin option can grant cluster-wide and in specific databases
CREATE ROLE role_granted;
SET SESSION AUTHORIZATION role_read_all_with_admin;
GRANT pg_read_all_data TO role_granted; -- success
GRANT pg_read_all_data TO role_granted IN CURRENT DATABASE; -- success
GRANT pg_read_all_data TO role_granted IN DATABASE db_1; -- success
GRANT role_read_34 TO role_granted; -- error
ERROR:  permission denied to grant role "role_read_34"
DETAIL:  Only roles with the ADMIN option on role "role_read_34" may grant this role.
TABLE role_memberships;
           role           |          member          |         grantor          | admin_option | datname 
--------------------------+--------------------------+--------------------------+--------------+---------
 pg_maintain              | role_admin               | superuser                | t            | 
 pg_maintain              | role_read_12             | role_admin               | f            | db_2
 pg_read_all_data         | role_admin               | superuser                | t            | 
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | db_0
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | db_1
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | 
 pg_read_all_data         | role_read_12             | role_admin               | f            | db_2
 pg_read_all_data         | role_read_34             | role_admin               | t            | db_3
 pg_read_all_data         | role_read_34             | role_admin               | t            | db_4
 pg_read_all_data         | role_read_all_noinherit  | role_admin               | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin               | t            | 
 pg_read_all_stats        | role_admin               | superuser                | t            | 
 pg_read_all_stats        | role_read_0              | role_admin               | f            | 
 pg_read_all_stats        | role_read_34             | role_admin               | f            | db_3
 role_granted             | role_admin               | superuser                | t            | 
 role_inherited_3         | role_admin               | role_admin               | f            | 
 role_inherited_3         | role_admin               | superuser                | t            | 
 role_inherited_34        | role_admin               | role_admin               | f            | 
 role_inherited_34        | role_admin               | superuser                | t            | 
 role_read_0              | role_admin               | superuser                | t            | 
 role_read_12             | role_admin               | role_admin               | f            | 
 role_read_12             | role_admin               | superuser                | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin               | f            | 
 role_read_12_noinherit   | role_admin               | role_admin               | f            | 
 role_read_12_noinherit   | role_admin               | superuser                | t            | 
 role_read_34             | role_admin               | role_admin               | f            | 
 role_read_34             | role_admin               | superuser                | t            | 
 role_read_34             | role_inherited_3         | role_admin               | f            | db_3
 role_read_34             | role_inherited_34        | role_admin               | f            | 
 role_read_all_noinherit  | role_admin               | role_admin               | f            | 
 role_read_all_noinherit  | role_admin               | superuser                | t            | 
 role_read_all_with_admin | role_admin               | role_admin               | f            | 
 role_read_all_with_admin | role_admin               | superuser                | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin               | f            | 
(34 rows)

-- Ensure database-specific admin option can only grant within that database
SET SESSION AUTHORIZATION role_read_34;
GRANT pg_read_all_data TO role_granted; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
GRANT pg_read_all_data TO role_granted IN CURRENT DATABASE; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
GRANT pg_read_all_data TO role_granted IN DATABASE db_3; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
GRANT pg_read_all_data TO role_granted IN DATABASE db_4; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
\connect db_3
SET SESSION AUTHORIZATION role_read_34;
GRANT pg_read_all_data TO role_granted; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
GRANT pg_read_all_data TO role_granted IN CURRENT DATABASE; -- success
GRANT pg_read_all_data TO role_granted IN DATABASE db_3; -- notice
NOTICE:  role "role_granted" has already been granted membership in role "pg_read_all_data" in database "db_3" by role "role_read_34"
GRANT pg_read_all_data TO role_granted IN DATABASE db_4; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
\connect db_4
SET SESSION AUTHORIZATION role_read_34;
GRANT pg_read_all_data TO role_granted; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
GRANT pg_read_all_data TO role_granted IN CURRENT DATABASE; -- success
GRANT pg_read_all_data TO role_granted IN DATABASE db_3; -- error
ERROR:  permission denied to grant role "pg_read_all_data"
DETAIL:  Only roles with the ADMIN option on role "pg_read_all_data" may grant this role.
GRANT pg_read_all_data TO role_granted IN DATABASE db_4; -- notice
NOTICE:  role "role_granted" has already been granted membership in role "pg_read_all_data" in database "db_4" by role "role_read_34"
\connect db_0
SET SESSION AUTHORIZATION role_admin;
TABLE role_memberships;
           role           |          member          |         grantor          | admin_option | datname 
--------------------------+--------------------------+--------------------------+--------------+---------
 pg_maintain              | role_admin               | superuser                | t            | 
 pg_maintain              | role_read_12             | role_admin               | f            | db_2
 pg_read_all_data         | role_admin               | superuser                | t            | 
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | db_0
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | db_1
 pg_read_all_data         | role_granted             | role_read_34             | f            | db_3
 pg_read_all_data         | role_granted             | role_read_34             | f            | db_4
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | 
 pg_read_all_data         | role_read_12             | role_admin               | f            | db_2
 pg_read_all_data         | role_read_34             | role_admin               | t            | db_3
 pg_read_all_data         | role_read_34             | role_admin               | t            | db_4
 pg_read_all_data         | role_read_all_noinherit  | role_admin               | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin               | t            | 
 pg_read_all_stats        | role_admin               | superuser                | t            | 
 pg_read_all_stats        | role_read_0              | role_admin               | f            | 
 pg_read_all_stats        | role_read_34             | role_admin               | f            | db_3
 role_granted             | role_admin               | superuser                | t            | 
 role_inherited_3         | role_admin               | role_admin               | f            | 
 role_inherited_3         | role_admin               | superuser                | t            | 
 role_inherited_34        | role_admin               | role_admin               | f            | 
 role_inherited_34        | role_admin               | superuser                | t            | 
 role_read_0              | role_admin               | superuser                | t            | 
 role_read_12             | role_admin               | role_admin               | f            | 
 role_read_12             | role_admin               | superuser                | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin               | f            | 
 role_read_12_noinherit   | role_admin               | role_admin               | f            | 
 role_read_12_noinherit   | role_admin               | superuser                | t            | 
 role_read_34             | role_admin               | role_admin               | f            | 
 role_read_34             | role_admin               | superuser                | t            | 
 role_read_34             | role_inherited_3         | role_admin               | f            | db_3
 role_read_34             | role_inherited_34        | role_admin               | f            | 
 role_read_all_noinherit  | role_admin               | role_admin               | f            | 
 role_read_all_noinherit  | role_admin               | superuser                | t            | 
 role_read_all_with_admin | role_admin               | role_admin               | f            | 
 role_read_all_with_admin | role_admin               | superuser                | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin               | f            | 
(36 rows)

-- Should clean up the membership table when dropping a database
DROP DATABASE db_4;
DROP DATABASE db_3;
DROP DATABASE db_2;
DROP DATABASE db_1;
TABLE role_memberships;
           role           |          member          |         grantor          | admin_option | datname 
--------------------------+--------------------------+--------------------------+--------------+---------
 pg_maintain              | role_admin               | superuser                | t            | 
 pg_read_all_data         | role_admin               | superuser                | t            | 
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | db_0
 pg_read_all_data         | role_granted             | role_read_all_with_admin | f            | 
 pg_read_all_data         | role_read_all_noinherit  | role_admin               | f            | db_0
 pg_read_all_data         | role_read_all_with_admin | role_admin               | t            | 
 pg_read_all_stats        | role_admin               | superuser                | t            | 
 pg_read_all_stats        | role_read_0              | role_admin               | f            | 
 role_granted             | role_admin               | superuser                | t            | 
 role_inherited_3         | role_admin               | role_admin               | f            | 
 role_inherited_3         | role_admin               | superuser                | t            | 
 role_inherited_34        | role_admin               | role_admin               | f            | 
 role_inherited_34        | role_admin               | superuser                | t            | 
 role_read_0              | role_admin               | superuser                | t            | 
 role_read_12             | role_admin               | role_admin               | f            | 
 role_read_12             | role_admin               | superuser                | t            | 
 role_read_12             | role_read_12_noinherit   | role_admin               | f            | 
 role_read_12_noinherit   | role_admin               | role_admin               | f            | 
 role_read_12_noinherit   | role_admin               | superuser                | t            | 
 role_read_34             | role_admin               | role_admin               | f            | 
 role_read_34             | role_admin               | superuser                | t            | 
 role_read_34             | role_inherited_34        | role_admin               | f            | 
 role_read_all_noinherit  | role_admin               | role_admin               | f            | 
 role_read_all_noinherit  | role_admin               | superuser                | t            | 
 role_read_all_with_admin | role_admin               | role_admin               | f            | 
 role_read_all_with_admin | role_admin               | superuser                | t            | 
 role_read_all_with_admin | role_read_all_noinherit  | role_admin               | f            | 
(27 rows)

-- Should clean up the membership table when dropping a role
DROP ROLE role_granted;  -- dependency of 'role_read_34'
DROP ROLE role_read_34;
DROP ROLE role_inherited_3;
DROP ROLE role_inherited_34;
DROP ROLE role_read_0;
DROP ROLE role_read_12;
DROP ROLE role_read_12_noinherit;
DROP ROLE role_read_all_noinherit;
DROP ROLE role_read_all_with_admin;
RESET SESSION AUTHORIZATION;
DROP OWNED BY role_admin CASCADE;
TABLE role_memberships;
       role        |   member   |  grantor  | admin_option | datname 
-------------------+------------+-----------+--------------+---------
 pg_maintain       | role_admin | superuser | t            | 
 pg_read_all_data  | role_admin | superuser | t            | 
 pg_read_all_stats | role_admin | superuser | t            | 
(3 rows)

\connect template1
DROP DATABASE db_0;
DROP ROLE role_admin;
SELECT datname FROM pg_database WHERE datname LIKE 'db_%';
 datname 
---------
(0 rows)

SELECT rolname FROM pg_roles WHERE rolname LIKE 'role_%';
 rolname 
---------
(0 rows)

